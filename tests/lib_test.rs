use approx::assert_abs_diff_eq;
use nalgebra as na;
use rust_anpass::Anpass;

type Dmat = na::DMatrix<f64>;
type Dvec = na::DVector<f64>;

#[test]
fn test_load() {
    let anpass = Anpass::load("testfiles/anpass.in");
    let want = Anpass {
        #[rustfmt::skip]
            disps: Dmat::from_row_slice(
                69,
                3,
                &vec![
                    -0.00500000, -0.00500000, -0.01000000,
                    -0.00500000, -0.00500000, 0.00000000,
                    -0.00500000, -0.00500000, 0.01000000,
                    -0.00500000, -0.01000000, 0.00000000,
                    -0.00500000, -0.01500000, 0.00000000,
                    -0.00500000, 0.00000000, -0.01000000,
                    -0.00500000, 0.00000000, 0.00000000,
                    -0.00500000, 0.00000000, 0.01000000,
                    -0.00500000, 0.00500000, -0.01000000,
                    -0.00500000, 0.00500000, 0.00000000,
                    -0.00500000, 0.00500000, 0.01000000,
                    -0.00500000, 0.01000000, 0.00000000,
                    -0.00500000, 0.01500000, 0.00000000,
                    -0.01000000, -0.00500000, 0.00000000,
                    -0.01000000, -0.01000000, 0.00000000,
                    -0.01000000, 0.00000000, -0.01000000,
                    -0.01000000, 0.00000000, 0.00000000,
                    -0.01000000, 0.00000000, 0.01000000,
                    -0.01000000, 0.00500000, 0.00000000,
                    -0.01000000, 0.01000000, 0.00000000,
                    -0.01500000, -0.00500000, 0.00000000,
                    -0.01500000, 0.00000000, 0.00000000,
                    -0.01500000, 0.00500000, 0.00000000,
                    -0.02000000, 0.00000000, 0.00000000,
                    0.00000000, -0.00500000, -0.01000000,
                    0.00000000, -0.00500000, 0.00000000,
                    0.00000000, -0.00500000, 0.01000000,
                    0.00000000, -0.01000000, -0.01000000,
                    0.00000000, -0.01000000, 0.00000000,
                    0.00000000, -0.01000000, 0.01000000,
                    0.00000000, -0.01500000, 0.00000000,
                    0.00000000, -0.02000000, 0.00000000,
                    0.00000000, 0.00000000, -0.01000000,
                    0.00000000, 0.00000000, -0.02000000,
                    0.00000000, 0.00000000, 0.00000000,
                    0.00000000, 0.00000000, 0.01000000,
                    0.00000000, 0.00000000, 0.02000000,
                    0.00000000, 0.00500000, -0.01000000,
                    0.00000000, 0.00500000, 0.00000000,
                    0.00000000, 0.00500000, 0.01000000,
                    0.00000000, 0.01000000, -0.01000000,
                    0.00000000, 0.01000000, 0.00000000,
                    0.00000000, 0.01000000, 0.01000000,
                    0.00000000, 0.01500000, 0.00000000,
                    0.00000000, 0.02000000, 0.00000000,
                    0.00500000, -0.00500000, -0.01000000,
                    0.00500000, -0.00500000, 0.00000000,
                    0.00500000, -0.00500000, 0.01000000,
                    0.00500000, -0.01000000, 0.00000000,
                    0.00500000, -0.01500000, 0.00000000,
                    0.00500000, 0.00000000, -0.01000000,
                    0.00500000, 0.00000000, 0.00000000,
                    0.00500000, 0.00000000, 0.01000000,
                    0.00500000, 0.00500000, -0.01000000,
                    0.00500000, 0.00500000, 0.00000000,
                    0.00500000, 0.00500000, 0.01000000,
                    0.00500000, 0.01000000, 0.00000000,
                    0.00500000, 0.01500000, 0.00000000,
                    0.01000000, -0.00500000, 0.00000000,
                    0.01000000, -0.01000000, 0.00000000,
                    0.01000000, 0.00000000, -0.01000000,
                    0.01000000, 0.00000000, 0.00000000,
                    0.01000000, 0.00000000, 0.01000000,
                    0.01000000, 0.00500000, 0.00000000,
                    0.01000000, 0.01000000, 0.00000000,
                    0.01500000, -0.00500000, 0.00000000,
                    0.01500000, 0.00000000, 0.00000000,
                    0.01500000, 0.00500000, 0.00000000,
                    0.02000000, 0.00000000, 0.00000000,
                ],
            ),
        #[rustfmt::skip]
            energies: Dvec::from(vec![
                0.000128387078, 0.000027809414, 0.000128387078,
                0.000035977201, 0.000048243883, 0.000124321064,
                0.000023720402, 0.000124321065, 0.000124313373,
                0.000023689948, 0.000124313373, 0.000027697745,
                0.000035723392, 0.000102791171, 0.000113093098,
                0.000199639109, 0.000096581025, 0.000199639109,
                0.000094442297, 0.000096354531, 0.000228163468,
                0.000219814727, 0.000215550318, 0.000394681651,
                0.000100159437, 0.000001985383, 0.000100159437,
                0.000106187756, 0.000008036587, 0.000106187756,
                0.000018173585, 0.000032416257, 0.000098196697,
                0.000392997365, 0.000000000000, 0.000098196697,
                0.000392997364, 0.000100279477, 0.000002060371,
                0.000100279477, 0.000106387616, 0.000008146336,
                0.000106387616, 0.000018237641, 0.000032313930,
                0.000119935606, 0.000024112936, 0.000119935606,
                0.000028065156, 0.000036090120, 0.000120058596,
                0.000024213636, 0.000120058597, 0.000124214356,
                0.000028347337, 0.000124214356, 0.000036494030,
                0.000048633604, 0.000093011998, 0.000094882871,
                0.000188725453, 0.000095181193, 0.000188725453,
                0.000101370691, 0.000111560627, 0.000207527972,
                0.000211748039, 0.000219975758, 0.000372784451,
            ]),
        exponents: na::DMatrix::from_row_slice(
            3,
            22,
            &vec![
                0, 1, 0, 2, 1, 0, 0, 3, 2, 1, 0, 1, 0, 4, 3, 2, 1, 0, 2, 1, 0,
                0, 0, 0, 1, 0, 1, 2, 0, 0, 1, 2, 3, 0, 1, 0, 1, 2, 3, 4, 0, 1,
                2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 2,
                2, 2, 4,
            ],
        ),
        biases: vec![],
    };
    assert_abs_diff_eq!(anpass.disps, want.disps);
    assert_eq!(anpass.energies.len(), want.energies.len());
    assert_abs_diff_eq!(anpass.energies, want.energies);
    assert_eq!(anpass.exponents, want.exponents);
    assert_eq!(anpass.biases, want.biases);

    let got2 = Anpass::load("testfiles/anpass2.in");
    let want2 = Anpass {
        biases: vec![
            -0.000045311426,
            -0.000027076533,
            0.000000000000,
            -0.000000002131,
        ],
        ..want
    };
    assert_abs_diff_eq!(got2.disps, want2.disps);
    assert_eq!(got2.energies.len(), want2.energies.len());
    assert_abs_diff_eq!(got2.energies, want2.energies);
    assert_eq!(got2.exponents, want2.exponents);
    assert_eq!(got2.biases, want2.biases);
}

#[test]
fn test_fit() {
    let anpass = Anpass::load("testfiles/anpass.in");
    let (got, _) = anpass.fit();
    let want = na::dvector![
        0.000000000002,
        0.000089167279,
        0.000008169225,
        0.958637185499,
        0.083537964315,
        0.080915238785,
        0.981791444232,
        -1.591452827847,
        -0.070076217196,
        -0.051299430149,
        -0.026818359356,
        -4.756703979348,
        0.045054940572,
        1.738582446151,
        -0.011114861654,
        0.021333149445,
        0.039547883446,
        -0.006274696681,
        10.448008327803,
        -0.141251401874,
        -0.047081672237,
        1.754904394438
    ];
    assert_abs_diff_eq!(got, want, epsilon = 1e-9);
}

#[test]
fn test_newton() {
    let anpass = Anpass::load("testfiles/c3h2.in");
    let (coeffs, _) = anpass.fit();
    let got = anpass.newton(&coeffs);
    let want = na::dvector![
        -0.000124209618,
        0.000083980449,
        -0.000036821098,
        -0.000117696241,
        0.000000000000,
        0.000000000000,
        0.000000000000,
        0.000000000000,
        0.000000000000,
        -0.000000022736
    ];
    assert_abs_diff_eq!(got, want, epsilon = 1e-12);
}
